# BARMMS Deployment Guide for Render

This guide provides step-by-step instructions for deploying the BARMMS (Barangay Management System) application to Render.

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Pre-Deployment Setup](#pre-deployment-setup)
3. [Deployment Methods](#deployment-methods)
4. [Step-by-Step Deployment](#step-by-step-deployment)
5. [Post-Deployment Configuration](#post-deployment-configuration)
6. [Troubleshooting](#troubleshooting)
7. [Maintenance & Updates](#maintenance--updates)

---

## Prerequisites

Before deploying, ensure you have:

- ✅ A Render account ([sign up here](https://render.com))
- ✅ A GitHub/GitLab/Bitbucket account with your code repository
- ✅ Your repository pushed to the remote (GitHub/GitLab/Bitbucket)
- ✅ Mailgun account (for email functionality) or another mail service
- ✅ Basic understanding of Laravel and environment variables

---

## Pre-Deployment Setup

### 1. Prepare Your Repository

Ensure your repository includes:
- ✅ `render.yaml` (deployment configuration)
- ✅ `Dockerfile` (for Laravel app)
- ✅ `composer.json` and `composer.lock`
- ✅ `package.json` and `package-lock.json`
- ✅ `analytics_service/requirements.txt`
- ✅ All application files committed and pushed

### 2. Environment Variables Checklist

Prepare the following environment variables (you'll set these in Render):

**Application Variables:**
- `APP_URL` - Your Render app URL (e.g., `https://barmms-web.onrender.com`)
- `APP_KEY` - Laravel application key (auto-generated by Render)

**Mail Configuration:**
- `MAILGUN_DOMAIN` - Your Mailgun domain
- `MAILGUN_SECRET` - Your Mailgun API secret
- `MAIL_FROM_ADDRESS` - Sender email address

**Database:**
- Automatically configured via `render.yaml` (PostgreSQL)

**Analytics Service:**
- Automatically configured via `render.yaml`

---

## Deployment Methods

You can deploy using one of two methods:

### Method 1: Using render.yaml (Recommended)
This method uses Infrastructure as Code and deploys all services at once.

### Method 2: Manual Setup
This method involves creating each service manually through the Render dashboard.

---

## Step-by-Step Deployment

### Method 1: Deploy Using render.yaml

#### Step 1: Connect Your Repository

1. Log in to [Render Dashboard](https://dashboard.render.com)
2. Click **"New +"** → **"Blueprint"**
3. Connect your Git repository (GitHub/GitLab/Bitbucket)
4. Select the repository containing BARMMS
5. Render will detect `render.yaml` automatically

#### Step 2: Review Configuration

1. Render will parse `render.yaml` and show you:
   - **barmms-web** (Laravel application)
   - **barmms-analytics** (Python Flask service)
   - **barmms-db** (PostgreSQL database)

2. Review the configuration:
   - **Plan**: Starter plan is free but limited. Upgrade to Standard/Pro for production.
   - **Region**: Choose the closest region to your users
   - **Branch**: Ensure it matches your main branch name

#### Step 3: Apply Blueprint

1. Click **"Apply"** to create all services
2. Render will:
   - Create the PostgreSQL database
   - Deploy the Laravel web service
   - Deploy the Python analytics service
   - Link them together automatically

#### Step 4: Configure Environment Variables

After services are created, configure additional environment variables:

1. Go to **barmms-web** service → **Environment**
2. Add/Update these variables:

```
APP_URL=https://your-app-name.onrender.com
MAILGUN_DOMAIN=your-mailgun-domain.mailgun.org
MAILGUN_SECRET=your-mailgun-api-secret
MAIL_FROM_ADDRESS=noreply@yourdomain.com
```

3. Save changes (this will trigger a redeploy)

#### Step 5: Run Database Migrations

1. Go to **barmms-web** service → **Shell**
2. Run the following commands:

```bash
php artisan migrate --force
php artisan db:seed --force  # Optional: if you have seeders
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

#### Step 6: Verify Deployment

1. Check service health:
   - **barmms-web**: Visit `https://your-app-name.onrender.com`
   - **barmms-analytics**: Check `/health` endpoint

2. Verify database connection:
   - Check logs for any database errors
   - Ensure migrations ran successfully

---

### Method 2: Manual Setup

#### Step 1: Create PostgreSQL Database

1. Go to Render Dashboard → **"New +"** → **"PostgreSQL"**
2. Configure:
   - **Name**: `barmms-db`
   - **Database**: `barmms`
   - **User**: `barmms_user`
   - **Region**: Choose your region
   - **Plan**: Starter (or higher for production)
3. Click **"Create Database"**
4. **Save the connection details** (you'll need them later)

#### Step 2: Deploy Laravel Web Service

1. Go to **"New +"** → **"Web Service"**
2. Connect your repository
3. Configure the service:

   **Basic Settings:**
   - **Name**: `barmms-web`
   - **Region**: Same as database
   - **Branch**: `main` (or your main branch)
   - **Root Directory**: `/` (root)
   - **Runtime**: `Docker`
   - **Dockerfile Path**: `./Dockerfile`
   - **Docker Context**: `.`

   **Build & Deploy:**
   - **Build Command**: (leave empty, handled by Dockerfile)
   - **Start Command**: (leave empty, handled by Dockerfile)

   **Environment Variables:**
   ```
   APP_NAME=BARMMS
   APP_ENV=production
   APP_DEBUG=false
   APP_URL=https://barmms-web.onrender.com
   LOG_CHANNEL=stderr
   LOG_LEVEL=error
   
   DB_CONNECTION=pgsql
   DB_HOST=<from database>
   DB_PORT=<from database>
   DB_DATABASE=<from database>
   DB_USERNAME=<from database>
   DB_PASSWORD=<from database>
   
   CACHE_DRIVER=file
   SESSION_DRIVER=file
   QUEUE_CONNECTION=sync
   
   MAIL_MAILER=mailgun
   MAILGUN_DOMAIN=your-domain.mailgun.org
   MAILGUN_SECRET=your-secret-key
   MAIL_FROM_ADDRESS=noreply@yourdomain.com
   MAIL_FROM_NAME=BARMMS
   
   ANALYTICS_SERVICE_URL=https://barmms-analytics.onrender.com
   
   APP_KEY=<generate new key>
   ```

4. Click **"Create Web Service"**

#### Step 3: Deploy Python Analytics Service

1. Go to **"New +"** → **"Web Service"**
2. Connect the same repository
3. Configure the service:

   **Basic Settings:**
   - **Name**: `barmms-analytics`
   - **Region**: Same as other services
   - **Branch**: `main`
   - **Root Directory**: `/analytics_service`
   - **Runtime**: `Python 3`
   - **Build Command**: `pip install -r requirements.txt`
   - **Start Command**: `gunicorn --bind 0.0.0.0:$PORT --workers 2 --timeout 120 app:app`

   **Environment Variables:**
   ```
   PORT=5000
   DEBUG=false
   PYTHON_VERSION=3.11
   ```

4. Click **"Create Web Service"**

#### Step 4: Link Services

1. Go to **barmms-web** → **Environment**
2. Update `ANALYTICS_SERVICE_URL` to point to your analytics service URL
3. Save changes

#### Step 5: Run Migrations

Follow Step 5 from Method 1 above.

---

## Post-Deployment Configuration

### 1. Set Up Custom Domain (Optional)

1. Go to your web service → **Settings** → **Custom Domains**
2. Add your domain
3. Follow DNS configuration instructions
4. Update `APP_URL` environment variable

### 2. Configure SSL

SSL certificates are automatically provisioned by Render for all services.

### 3. Set Up Scheduled Tasks (Cron Jobs)

For Laravel scheduled tasks:

1. Go to **barmms-web** → **Settings** → **Cron Jobs**
2. Add cron job:
   - **Schedule**: `* * * * *` (every minute)
   - **Command**: `php artisan schedule:run`

Or use Render's Cron Jobs feature:
1. Create a new **Cron Job** service
2. Configure:
   - **Schedule**: `* * * * *`
   - **Command**: `cd /opt/render/project/src && php artisan schedule:run`
   - Link to your web service

### 4. Configure File Storage

For production, consider using cloud storage:

1. Install Laravel storage driver (S3, etc.)
2. Update `FILESYSTEM_DISK` environment variable
3. Configure storage credentials

### 5. Set Up Monitoring

1. Enable **Render Metrics** in service settings
2. Set up **Alerts** for service health
3. Monitor logs regularly

---

## Troubleshooting

### Common Issues

#### 1. Database Connection Errors

**Symptoms**: `SQLSTATE[HY000] [2002] Connection refused`

**Solutions**:
- Verify database credentials in environment variables
- Ensure database is in the same region as web service
- Check database status in Render dashboard
- Verify `DB_CONNECTION=pgsql` is set

#### 2. Application Key Not Set

**Symptoms**: `No application encryption key has been specified`

**Solutions**:
- Ensure `APP_KEY` is set (auto-generated by Render)
- Run: `php artisan key:generate --force` in shell
- Or set manually: `APP_KEY=base64:...`

#### 3. Analytics Service Not Reachable

**Symptoms**: Laravel can't connect to analytics service

**Solutions**:
- Verify `ANALYTICS_SERVICE_URL` is correct
- Check analytics service health endpoint
- Ensure both services are in the same region
- Check CORS settings in analytics service

#### 4. Build Failures

**Symptoms**: Docker build fails

**Solutions**:
- Check Dockerfile syntax
- Verify all required files are in repository
- Check build logs for specific errors
- Ensure Node.js and PHP versions are compatible

#### 5. Permission Errors

**Symptoms**: `Permission denied` for storage/cache

**Solutions**:
- Dockerfile should set correct permissions
- If needed, add to Dockerfile:
  ```dockerfile
  RUN chown -R www-data:www-data storage bootstrap/cache
  RUN chmod -R 775 storage bootstrap/cache
  ```

#### 6. Memory Issues

**Symptoms**: Service crashes or out of memory errors

**Solutions**:
- Upgrade to a higher plan (Standard/Pro)
- Optimize application code
- Reduce worker count in analytics service
- Enable swap if available

### Checking Logs

1. **Render Dashboard**: Go to service → **Logs** tab
2. **Real-time logs**: Click **"View Live Logs"**
3. **Historical logs**: Scroll through log history
4. **Filter logs**: Use search functionality

### Database Access

1. Go to database service → **Info** tab
2. Use **"Connect"** button for connection string
3. Use **"psql"** command in shell for direct access
4. Or use external tool (pgAdmin, DBeaver) with connection details

---

## Maintenance & Updates

### Updating Application

1. **Push changes to repository**
2. Render automatically detects changes and redeploys
3. Monitor deployment logs
4. Verify application after deployment

### Database Migrations

After code updates with new migrations:

1. Go to web service → **Shell**
2. Run: `php artisan migrate --force`
3. Check for errors

### Clearing Cache

If experiencing issues after updates:

```bash
php artisan config:clear
php artisan cache:clear
php artisan route:clear
php artisan view:clear
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

### Backup Database

1. Go to database service → **Backups** tab
2. Enable automatic backups
3. Or create manual backups as needed
4. Download backups for local storage

### Scaling Services

**Vertical Scaling** (more resources):
1. Go to service → **Settings** → **Plan**
2. Upgrade to higher plan
3. Service will restart with new resources

**Horizontal Scaling** (more instances):
- Currently not available on Starter plan
- Upgrade to Standard/Pro for multiple instances

### Cost Optimization

1. **Use Starter plan** for development/testing
2. **Upgrade to Standard/Pro** only for production
3. **Monitor usage** in Render dashboard
4. **Set up alerts** for unexpected usage
5. **Use free tier** PostgreSQL for development

---

## Environment Variables Reference

### Required Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `APP_URL` | Application URL | `https://barmms-web.onrender.com` |
| `APP_KEY` | Laravel encryption key | Auto-generated |
| `DB_CONNECTION` | Database driver | `pgsql` |
| `DB_HOST` | Database host | Auto-set from database |
| `DB_DATABASE` | Database name | Auto-set from database |
| `DB_USERNAME` | Database user | Auto-set from database |
| `DB_PASSWORD` | Database password | Auto-set from database |

### Optional Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `APP_ENV` | Environment | `production` |
| `APP_DEBUG` | Debug mode | `false` |
| `LOG_LEVEL` | Logging level | `error` |
| `CACHE_DRIVER` | Cache driver | `file` |
| `SESSION_DRIVER` | Session driver | `file` |
| `QUEUE_CONNECTION` | Queue driver | `sync` |
| `ANALYTICS_SERVICE_URL` | Analytics API URL | Auto-set |

---

## Security Best Practices

1. ✅ **Never commit `.env` file** to repository
2. ✅ **Use strong passwords** for database
3. ✅ **Enable HTTPS** (automatic on Render)
4. ✅ **Set `APP_DEBUG=false`** in production
5. ✅ **Use environment variables** for secrets
6. ✅ **Regularly update dependencies**
7. ✅ **Enable database backups**
8. ✅ **Monitor logs** for suspicious activity
9. ✅ **Use Mailgun or similar** for transactional emails
10. ✅ **Implement rate limiting** for APIs

---

## Support & Resources

- **Render Documentation**: https://render.com/docs
- **Laravel Documentation**: https://laravel.com/docs
- **Render Status**: https://status.render.com
- **Render Community**: https://community.render.com

---

## Quick Reference Commands

### Database Operations
```bash
# Run migrations
php artisan migrate --force

# Rollback last migration
php artisan migrate:rollback --force

# Seed database
php artisan db:seed --force

# Check migration status
php artisan migrate:status
```

### Cache Operations
```bash
# Clear all caches
php artisan optimize:clear

# Cache configuration
php artisan config:cache

# Cache routes
php artisan route:cache

# Cache views
php artisan view:cache
```

### Application Operations
```bash
# Generate application key
php artisan key:generate --force

# List routes
php artisan route:list

# Check environment
php artisan about
```

---

## Deployment Checklist

Before going live, ensure:

- [ ] All environment variables are set
- [ ] Database migrations are run
- [ ] `APP_DEBUG=false` in production
- [ ] `APP_URL` is correct
- [ ] Mail service is configured
- [ ] Analytics service is accessible
- [ ] SSL certificate is active
- [ ] Custom domain is configured (if applicable)
- [ ] Database backups are enabled
- [ ] Monitoring is set up
- [ ] Application is tested thoroughly
- [ ] Logs are being monitored
- [ ] Error pages are configured
- [ ] Scheduled tasks are set up (if needed)

---

**Last Updated**: 2024
**Version**: 1.0

For questions or issues, refer to Render's documentation or community forums.

